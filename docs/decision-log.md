# docs/decision-log.md — campus-hub 工程决策记录

> 本文档用于记录 **campus-hub 项目中的关键工程决策**。
>
> 目的：
>
> * 防止重复讨论已经想清楚的问题
> * 保证多人 / 多轮开发中的工程一致性
> * 为未来回溯与重构提供上下文依据
>
> 规则：
>
> * 只记录「已经做出的决定」
> * 每条决策必须说明 **为什么这样选**
> * 若决策被推翻，应新增记录而非删除旧记录

---

## DL-001 项目定位与目标

* **状态**：Accepted
* **日期**：2025-12

### 决策

campus-hub 定位为一个 **面向高校校园的社区平台 Demo**，融合论坛、校内墙、实时聊天与资料互助功能。

### 原因

* 校园场景信息密集、需求真实
* 功能复杂度适中，适合作为完整工程练习
* 可扩展为长期项目

### 影响

* 后续功能设计需围绕“社区/交流”展开
* 非核心功能（商业化、推荐算法）暂不纳入

---

## DL-002 工程名称与命名策略

* **状态**：Accepted
* **日期**：2025-12

### 决策

* Git 仓库名使用 **campus-hub**（暂定）
* 产品展示名使用 **校圈**（可变）

### 原因

* 工程名需技术中性、长期可用
* 产品名允许根据场景与 UI 调整

### 影响

* 文档、代码、目录结构统一使用 campus-hub
* 对外展示可使用不同产品名

---

## DL-003 技术路线选择

* **状态**：Accepted
* **日期**：2025-12

### 决策

采用分阶段技术路线：

* Phase A：Web 客户端 + Go 后端（Demo）
* Phase B：工程加固（协议冻结）
* Phase C：迁移至 Kotlin Multiplatform 客户端

### 原因

* Web 开发效率高，Demo 成功率最大
* Go 后端稳定、性能好、长期维护成本低
* KMP 适合作为后期长期客户端方案

### 影响

* 后端 API 与 WebSocket 协议需优先稳定
* 客户端实现需遵循协议而非私有逻辑

---

## DL-004 架构原则

* **状态**：Accepted
* **日期**：2025-12

### 决策

确立以下架构原则：

* 后端稳定，客户端可替换
* 协议优先于 UI
* 核心领域模型优先冻结

### 原因

* 避免客户端更换导致系统重写
* 降低技术选型变化的影响

### 影响

* API / WS 协议修改需谨慎
* 新功能需评估对领域模型的影响

---

## DL-005 WebSocket 协议设计策略

* **状态**：Accepted
* **日期**：2025-12

### 决策

WebSocket 通信采用 **统一事件信封格式**，包含版本号与事件类型。

### 原因

* 便于多客户端（Web / KMP）共享协议
* 支持协议向后兼容与演进

### 影响

* 所有实时事件必须符合信封格式
* 客户端需按事件类型分发处理

---

## DL-006 文档体系规范

* **状态**：Accepted
* **日期**：2025-12

### 决策

项目文档拆分为以下核心文件：

* `docs/spec.md`
* `docs/api.md`
* `docs/ws-protocol.md`
* `docs/decision-log.md`

### 原因

* 单一文档难以承载不同层级信息
* 分离后更易维护与演进

### 影响

* 新增协议或核心设计需更新对应文档
* 关键决策必须记录在 decision-log 中

---

## DL-007 认证：引入注册与密码校验

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 新增注册接口：`POST /api/v1/auth/register`
- 登录接口不再创建匿名用户：`POST /api/v1/auth/login` 必须账号存在且密码正确才会返回 token
- 密码存储：仅保存 bcrypt 哈希，不保存明文
- token：服务端生成随机 token；Demo 阶段暂不做过期（后续可加入 `expires_at`）

### 原因

- 匿名登录不利于后续权限与数据归属
- 账号 + 密码是最基础的鉴权能力，便于后续做角色/权限/资源权限
- bcrypt 可降低密码泄露风险（相比明文或简单哈希）

### 影响

- 前端需要先注册再登录（见 `apps/web`）
- SQLite 数据库新增 `accounts.password_hash` 字段；老数据库里已有账号但没有密码时，允许通过注册补齐密码后继续使用

## DL-008 Web 前端技术栈：Vue 3 + TypeScript + Vite + Naive UI

* **状态**：Accepted
* **日期**：2025-12

### 决策

- Web 前端统一使用：Vue 3 + TypeScript + Vite + Naive UI
- `apps/web` 作为前端工程目录（后续会从当前 Demo 页面演进/迁移）

### 原因

- Vue 3 生态成熟，适合快速迭代与长期维护
- TypeScript 提升可维护性（对新手也更容易在 IDE 里“看懂类型”）
- Vite 启动/热更新快，开发体验好
- Naive UI 组件丰富、风格统一，减少重复造 UI 轮子

### 影响

- 开发阶段通常使用 Vite Dev Server（可通过代理转发到 Go 后端的 `/api/v1` 与 `/ws`）
- 生产构建输出会变成静态资源（通常是 `dist/`），可由 Go/Nginx/CDN 提供

---

> 本决策记录为 **长期文档**，应随项目演进持续追加。

---

## DL-009 帖子列表交互对齐 Reddit 风格

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 帖子列表卡片展示正文预览。
- 互动区采用「点赞 / 点踩 / 分值 / 评论数 / Award / 分享」的组合。
- 分值初始为 0，Award 需要消耗用户账户资源（具体规则由后端补充）。

### 原因

- Reddit 风格的信息层级成熟，便于浏览与快速扫描。
- 互动控件集中在卡片底部，用户心智清晰。

### 影响

- 列表接口需返回正文内容与互动计数字段（score、comment_count）。
- 需新增投票持久化与接口（vote + cancel），并在列表/详情返回 my_vote。
- Award 独立系统后续补充。


## DL-010 评论楼中楼（parent_id）

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 评论支持 parent_id 字段，用于表达回复关系。
- 列表接口返回 parent_id，前端按 parent_id 组装树形。

### 原因

- 贴近 Reddit 的讨论体验，便于跟踪上下文。
- 后端保持扁平存储，前端负责渲染层级。

### 影响

- 评论表新增 parent_id 字段。
- 评论创建接口允许 parent_id，可为空。


## DL-011 ???????

* **??**?Accepted
* **??**?2025-12

### ??

- ???????????????????POST/DELETE votes??
- ???? score / my_vote?????????

### ??

- ??????????????????
- ???????????

### ??

- ?? comment_votes ?????????
- ???????????? score / my_vote ???
