# docs/decision-log.md — campus-hub 工程决策记录

> 本文档用于记录 **campus-hub 项目中的关键工程决策**。
>
> 目的：
>
> * 防止重复讨论已经想清楚的问题
> * 保证多人 / 多轮开发中的工程一致性
> * 为未来回溯与重构提供上下文依据
>
> 规则：
>
> * 只记录「已经做出的决定」
> * 每条决策必须说明 **为什么这样选**
> * 若决策被推翻，应新增记录而非删除旧记录

---

## DL-001 项目定位与目标

* **状态**：Accepted
* **日期**：2025-12

### 决策

campus-hub 定位为一个 **面向高校校园的社区平台 Demo**，融合论坛、校内墙、实时聊天与资料互助功能。

### 原因

* 校园场景信息密集、需求真实
* 功能复杂度适中，适合作为完整工程练习
* 可扩展为长期项目

### 影响

* 后续功能设计需围绕“社区/交流”展开
* 非核心功能（商业化、推荐算法）暂不纳入

---

## DL-002 工程名称与命名策略

* **状态**：Accepted
* **日期**：2025-12

### 决策

* Git 仓库名使用 **campus-hub**（暂定）
* 产品展示名使用 **校圈**（可变）

### 原因

* 工程名需技术中性、长期可用
* 产品名允许根据场景与 UI 调整

### 影响

* 文档、代码、目录结构统一使用 campus-hub
* 对外展示可使用不同产品名

---

## DL-003 技术路线选择

* **状态**：Accepted
* **日期**：2025-12

### 决策

采用分阶段技术路线：

* Phase A：Web 客户端 + Go 后端（Demo）
* Phase B：工程加固（协议冻结）
* Phase C：迁移至 Kotlin Multiplatform 客户端

### 原因

* Web 开发效率高，Demo 成功率最大
* Go 后端稳定、性能好、长期维护成本低
* KMP 适合作为后期长期客户端方案

### 影响

* 后端 API 与 WebSocket 协议需优先稳定
* 客户端实现需遵循协议而非私有逻辑

---

## DL-004 架构原则

* **状态**：Accepted
* **日期**：2025-12

### 决策

确立以下架构原则：

* 后端稳定，客户端可替换
* 协议优先于 UI
* 核心领域模型优先冻结

### 原因

* 避免客户端更换导致系统重写
* 降低技术选型变化的影响

### 影响

* API / WS 协议修改需谨慎
* 新功能需评估对领域模型的影响

---

## DL-005 WebSocket 协议设计策略

* **状态**：Accepted
* **日期**：2025-12

### 决策

WebSocket 通信采用 **统一事件信封格式**，包含版本号与事件类型。

### 原因

* 便于多客户端（Web / KMP）共享协议
* 支持协议向后兼容与演进

### 影响

* 所有实时事件必须符合信封格式
* 客户端需按事件类型分发处理

---

## DL-006 文档体系规范

* **状态**：Accepted
* **日期**：2025-12

### 决策

项目文档拆分为以下核心文件：

* `docs/spec.md`
* `docs/api.md`
* `docs/ws-protocol.md`
* `docs/decision-log.md`

### 原因

* 单一文档难以承载不同层级信息
* 分离后更易维护与演进

### 影响

* 新增协议或核心设计需更新对应文档
* 关键决策必须记录在 decision-log 中

---

## DL-007 认证：引入注册与密码校验

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 新增注册接口：`POST /api/v1/auth/register`
- 登录接口不再创建匿名用户：`POST /api/v1/auth/login` 必须账号存在且密码正确才会返回 token
- 密码存储：仅保存 bcrypt 哈希，不保存明文
- token：服务端生成随机 token；Demo 阶段暂不做过期（后续可加入 `expires_at`）

### 原因

- 匿名登录不利于后续权限与数据归属
- 账号 + 密码是最基础的鉴权能力，便于后续做角色/权限/资源权限
- bcrypt 可降低密码泄露风险（相比明文或简单哈希）

### 影响

- 前端需要先注册再登录（见 `apps/web`）
- SQLite 数据库新增 `accounts.password_hash` 字段；老数据库里已有账号但没有密码时，允许通过注册补齐密码后继续使用

## DL-008 Web 前端技术栈：Vue 3 + TypeScript + Vite + Naive UI

* **状态**：Accepted
* **日期**：2025-12

### 决策

- Web 前端统一使用：Vue 3 + TypeScript + Vite + Naive UI
- `apps/web` 作为前端工程目录（后续会从当前 Demo 页面演进/迁移）

### 原因

- Vue 3 生态成熟，适合快速迭代与长期维护
- TypeScript 提升可维护性（对新手也更容易在 IDE 里“看懂类型”）
- Vite 启动/热更新快，开发体验好
- Naive UI 组件丰富、风格统一，减少重复造 UI 轮子

### 影响

- 开发阶段通常使用 Vite Dev Server（可通过代理转发到 Go 后端的 `/api/v1` 与 `/ws`）
- 生产构建输出会变成静态资源（通常是 `dist/`），可由 Go/Nginx/CDN 提供

---

> 本决策记录为 **长期文档**，应随项目演进持续追加。

---

## DL-009 帖子列表交互对齐 Reddit 风格

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 帖子列表卡片展示正文预览。
- 互动区采用「点赞 / 点踩 / 分值 / 评论数 / Award / 分享」的组合。
- 分值初始为 0，Award 需要消耗用户账户资源（具体规则由后端补充）。

### 原因

- Reddit 风格的信息层级成熟，便于浏览与快速扫描。
- 互动控件集中在卡片底部，用户心智清晰。

### 影响

- 列表接口需返回正文内容与互动计数字段（score、comment_count）。
- 需新增投票持久化与接口（vote + cancel），并在列表/详情返回 my_vote。
- Award 独立系统后续补充。


## DL-010 评论楼中楼（parent_id）

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 评论支持 parent_id 字段，用于表达回复关系。
- 列表接口返回 parent_id，前端按 parent_id 组装树形。

### 原因

- 贴近 Reddit 的讨论体验，便于跟踪上下文。
- 后端保持扁平存储，前端负责渲染层级。

### 影响

- 评论表新增 parent_id 字段。
- 评论创建接口允许 parent_id，可为空。


## DL-011 评论投票（vote/cancel）与返回字段

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 评论投票采用与帖子投票一致的接口语义：
	- 点赞/点踩：`POST /api/v1/posts/{post_id}/comments/{comment_id}/votes`
	- 取消投票：`DELETE /api/v1/posts/{post_id}/comments/{comment_id}/votes`
- 评论相关接口需要返回互动字段：`score` 与 `my_vote`（与帖子对齐）。

### 原因

- 保持「帖子/评论」互动能力一致，降低前端心智负担。
- `score` / `my_vote` 是列表渲染与交互态展示的必要字段。

### 影响

- 后端新增或完善 `comment_votes` 持久化（记录 user_id、comment_id、value）。
- 评论列表与投票接口需要能计算并返回 `score`（聚合）与 `my_vote`（当前用户）。


## DL-012 时间与时区约定（UTC 与 UTC+8）

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 所有 API 的时间字段统一使用 **UTC 的 RFC3339** 字符串（例如 `2025-01-01T00:00:00Z`）。
- **不**在服务端把时间“转换成 UTC+8 再返回”；时区展示由客户端决定（校园场景默认可展示为 UTC+8）。
- “x 分钟前 / 24 小时内”等相对时间显示由客户端基于 UTC 时间戳计算。

### 原因

- 统一以 UTC 作为协议层时间基准，可避免多端/多地区时区差异导致的歧义。

### 影响

- 数据库存储、服务端内部计算均以 UTC 处理；前端负责本地化展示。
- 文档中涉及“UTC+8”的描述应明确为「展示层约定」而非「接口返回约定」。

---

## DL-013 用户主页 Profile v1

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 路由统一为 `/u/:id`，从帖子/评论作者昵称进入个人主页。
- Profile v1 展示封面、头像、昵称、签名、基础资料卡、Tabs（Posts/Comments）。
- 后端尚无用户详情与按作者筛选接口时，前端先用 `GET /api/v1/posts` 本地过滤作为临时策略。

### 原因

- 个人主页是社区信任与互动的基础入口。
- 在后端接口完善前先保证前端体验可运行、可演示。

### 影响

- TODO：新增 `GET /api/v1/users/{id}` 用于公开资料（avatar/cover/bio/created_at）。
- TODO：新增 `GET /api/v1/posts?author_id={id}` 支持按作者筛选与分页。
- TODO：用户统计字段（posts_count/comments_count）用于资料卡展示。

---

## DL-014 关注/粉丝统计与列表规划

* **状态**：Accepted
* **日期**：2025-12

### 决策

- 个人主页资料卡中预留“关注数 / 粉丝数”展示。
- 关注列表与粉丝列表作为后续功能，在 Profile 页以 Tab 或二级入口承载。

### 原因

- 关注关系是社区用户关系的基础指标，且与个人主页强关联。
- 先展示统计，再补列表，可分阶段落地。

### 影响

- TODO：新增关注关系接口与分页列表（following/followers）。
- TODO：用户资料需返回 following_count / followers_count 以支持展示。

